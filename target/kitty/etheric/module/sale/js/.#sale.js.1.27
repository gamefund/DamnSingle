/**
 * 交配页面
 */
var sale_sireInit = function (params) {
    fadeInOutLoad(sale_sirePageLoad, params);
};

/**
 *  交配页面初始加载内容
 */
var sale_sirePageLoad = function (params) {
    var kitty_id = params.kitty_id;
    // var kitty_type = params.kitty_type;
    // var obj = {"page":"sale_sireInit","kitty_id":kitty_id,"kitty_type":kitty_type};
    var obj = {
        "page": "sale_sireInit",
        "paramJson": params
    };
    leftToRightArray.push(obj);
    headerInit();
    removeHeaderLine(); //移除header的导航栏选中下划线
    $("#all-container").append(sale_sireText);

    //默认放出交配界面
    sirePublicClick(kitty_id);

    //与公共猫交配标签事件
    $(".sale-sire-container .sire-small-title .sire-to-public").click(function () {
        sirePublicClick(kitty_id);
    });

    //与自己的猫交配标签事件
    $(".sale-sire-container .sire-small-title .sire-with-ownKitties").click(function () {
        sireOwnKittiesClick(kitty_id);
    });
}

/**
 * 放出交配标签点击执行的
 */
var sirePublicClick = function (kitty_id) {
    if ($(".sale-sire-container .sire-small-title .sire-to-public").hasClass("sale-sire-selected")) {
        return;
    }
    $(".my-kitties-choose").remove();
    $(".finish-setting-button").before(publicSireText);
    $(".sale-sire-container .sire-small-title .sire-to-public").addClass('sale-sire-selected');
    $(".sale-sire-container .setting-button").unbind("click");
    $(".sale-sire-container .setting-button").click(function () {
        waitModel();
        var start_price = $(".input-starting-price").val();
        var end_price = $(".input-end-price").val();
        var duration = $(".input-duration").val();
        var kittyId = kitty_id;
        release_sire(kittyId, start_price, end_price, duration);
    });
    $(".sale-sire-container .sire-small-title .sire-with-ownKitties").removeClass('sale-sire-selected');
}

/**
 * 自己的猫交配标签点击执行的
 */
var sireOwnKittiesClick = function (kitty_id) {
    if ($(".sale-sire-container .sire-small-title .sire-with-ownKitties").hasClass("sale-sire-selected")) {
        return;
    }
    waitModel();
    $(".setting-starting-price").remove();
    $(".setting-end-price").remove();
    $(".setting-duration").remove();
    $(".finish-setting-button").before(ownerSireText);
    $(".choose-kitty-input").append(my_kittiesSelect);
    getNotSiredKitties(kitty_id);
    $(".sale-sire-container .setting-button").unbind("click");
    $(".sale-sire-container .setting-button").click(function () {
        waitModel();
        var mId = kitty_id;
        var sId = $(".choose-kitty-input select").val();
        console.log(mId);
        // to_sire(sId,mId);
        webToSire(sId, mId, userId);
    });
    $(".sale-sire-container .sire-small-title .sire-with-ownKitties").addClass('sale-sire-selected');
    $(".sale-sire-container .sire-small-title .sire-to-public").removeClass('sale-sire-selected');
}


/**
 * 放出交配请求
 * @param kitty_id      猫ID
 * @param start_price   开始价格
 * @param end_price     最终价格
 * @param duration      时间间隔
 */
var release_sire = function (kitty_id, start_price, end_price, duration) {
    $.ajax({
        url: Config.address + "sire/releaseSireKitty",
        type: "POST",
        data: {
            "kitty_id": kitty_id,
            "type": 2,
            "start_price": start_price,
            "end_price": end_price,
            "duration": duration,
        },
        success: function (response) {
            console.info(response);
            var text = nextJson(LText.Title, response.error, 1, [LText.Cancle], [cancel]);
            promptText(text);
            destory();
        },
        error: function (error) {
            var text = nextJson(LText.Title, LText.SystemTitle, 1, [LText.Ok], [OK]);
            promptText(text);
            destory();
        }
    });
}

var cancel = function () {
    $('.prompt-main').remove();
    marketInit();
}

/**
 * 加载我的能够交配的猫
 * @param my_kitties
 */
var getMyKitties = function (my_kitties) {
    //我的猫数据 my_kitties
    for (var index in my_kitties) {
        var optionContent;
        try {
            optionContent = "undefined" == typeof (my_kitties[index].name) ? ("Kitty #" + my_kitties[index].id) : my_kitties[index].name;
        } catch (e) {
            console.log(e);
        }
        var my_kittiesText =
            '<option value="' + my_kitties[index].id + '">' + optionContent + '</option>';
        $(".choose-kitty-input select").append(my_kittiesText);
    }
};

/**
 * 获取可以交配的kitty
 * @param kittyId
 */
var getNotSiredKitties = function (kittyId) {
    $.ajax({
        url: Config.address + "sire/getNotSiredKitties",
        type: "POST",
        data: {
            "kittyId": kittyId,
            "uId": userId
        },
        success: function (response) {
            console.log(response.msg);
            getMyKitties(response.msg);
            destory();
        },
        error: function (error) {
            var text = nextJson(LText.Title, LText.SystemTitle, 1, [LText.Ok], [OK]);
            promptText(text);
            destory();
        }
    });
}

/**
 * 销售页面
 */
var sale_sellInit = function (params) {
    fadeInOutLoad(sale_sellPageLoad, params);
};

/**
 * 销售页面初始加载内容
 */
var sale_sellPageLoad = function (params) {
    var kitty_id = params.kitty_id;
    var obj = {
        "page": "sale_sellInit",
        "paramJson": params
    };
    leftToRightArray.push(obj);
    headerInit();
    removeHeaderLine(); //移除header的导航栏选中下划线

    $("#all-container").append(sale_sellText);

    $(".sale-sell-container .setting-button").click(function () {
        waitModel();
        console.log(456)
        goToShop(kitty_id)
    });
}

/**
 * 上架kitty
 */
var goToShop = function (kitty_id) {
    var startPrice = $('.input-starting-price').val();
    var endPrice = $('.input-end-price').val();
    var duration = $('.input-duration').val();
    var seller_id = userId;
    var kitty_id = kitty_id;
    var type = 1;
    $.ajax({
        url: Config.address + "sellKitties",
        type: "POST",
        data: {
            start_price: startPrice,
            type: type,
            end_price: endPrice,
            duration: duration,
            seller_id: seller_id,
            kitty_id: kitty_id,
        },
        success: function (response) {
            console.info(response);
            var text = nextJson(LText.Title, response.error, 1, [LText.Cancle], [cancel]);
            promptText(text);
            destory();
        },
        error: function (error) {
            var text = nextJson(LText.Title, LText.SystemTitle, 1, [LText.Ok], [OK]);
            promptText(text);
            destory();
        }
    });
}
/**
 * 赠送kitty页面
 * @param kitty_id
 */
var sale_giftInit = function (params) {
    fadeInOutLoad(sale_giftPageLoad, params);
}

/**
 * 送猫页面初始加载内容
 */
var sale_giftPageLoad = function (params) {
    var kitty_id = params.kitty_id;
    var kitty_type = params.kitty_type;
    // var obj = {"page": "sale_giftInit", "kitty_id": kitty_id, "kitty_type": kitty_type};
    var obj = {
        "page": "sale_giftInit",
        "paramJson": params
    };
    leftToRightArray.push(obj);
    headerInit();
    removeHeaderLine(); //移除header的导航栏选中下划线
    $("#all-container").append(sale_giftText);

    $(".sale-sell-container .setting-button").click(function () {
        waitModel();
        var kId = kitty_id;
        var rId = $(".input-duration").val();
        giftKitty(kId, rId);
    })
}

/**
 * 送猫请求
 * @param kId   猫ID
 * @param rId   对方ID
 */
var giftKitty = function (kId, rId) {
    $.ajax({
        url: Config.address + "giftKitty",
        type: "POST",
        data: {
            "type": 0x0011,
            "uId": userId,
            "kId": kId,
            "rId": rId,
        },
        success: function (response) {
            console.log(response);
            var text = nextJson(LText.Title, response.error, 1, [LText.Cancle], [cancel]);
            promptText(text);
            destory();
        },
        error: function (error) {
            console.info(error);
            var text = nextJson(LText.Title, LText.SystemTitle, 1, [LText.Ok], [OK]);
            promptText(text);
            destory();
        }
    });
}