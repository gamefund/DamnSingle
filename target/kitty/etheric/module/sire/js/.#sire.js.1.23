/**
 * kitty交配
 */
var sireInit = function (sireKittyId, kitty_type) {

    $("body").css("transition", "0.5s");
    $("body").css("transform", "scale(0.9)");
    $("body").css("opacity", "0.6");
    setTimeout(function () {
        $("#all-container").empty();
        $("body").css("transition", "0.5s");
        $("body").css("transform", "scale(1)");
        $("body").css("opacity", "1");

        var obj = {
            "page": "sireInit",
            "kitty_id": sireKittyId,
            "kitty_type": kitty_type
        };
        leftToRightArray.push(obj);
        headerInit();
        $("#all-container").append(sireText);
        //动态显示信息
        findKittyInfo(sireKittyId);
        var my_kittiesSelect =
            '<select validateevent="true" onchange="chooseSireKitty()">' +
            '<option value="">Please choose your Kitty</option>' +
            '</select>';
        $(".select-input").append(my_kittiesSelect);
        //ok按钮
        $(".ok-btn").on("click", function () {
            var kittyValue = $(".select-input select").val();
            var s_id = $(".select-input select").val() == "" ? yourKittyId : kitties[kittyValue].id;
            webToSire(s_id, sireKittyId, userId);
        });
    }, 400);

};

/**
 * 发送请求进行交配
 * @param {*} sId 
 * @param {*} mId 
 * @param {*} uId 
 */
var webToSire = function (sId,mId,uId) {
    if (!alertHasShow()) {
        waitModel("");
    }
    $.ajax({
        type: "POST",
        url: Config.address + "sire/toSire",
        data: {
            sId: sId,
            mId: mId,
            uId: uId,
        },
        success: function (data) {
            createShowChildCanvas(data);
        },
        error: function (XMLHttpRequest) {
            destory();
            failModel("", null);
        }
    });
};

var showInfo = function (sire) {
    var sirePrice = sire.sire_kitty.current_price * ethRate;
    $(".spend-sum").html(sirePrice.toFixed(4));
    try {
        if ("undefined" == typeof (sire.your_kitty.name) || sire.your_kitty.name == "") {
            $(".left-name").html("Kitty" + " #" + sire.your_kitty.id);
            $(".left-date-tube").html("Kitty" + " #" + sire.your_kitty.id);
        } else {
            $(".left-name").html("G" + sire.your_kitty.generation + "-" + sire.your_kitty.name);
            $(".left-date-tube").html("G" + sire.your_kitty.generation + "-" + sire.your_kitty.name);
        }
        if ("undefined" == typeof (sire.your_kitty.name) || sire.your_kitty.name == "") {
            $(".right-name").html("Kitty" + " #" + sire.sire_kitty.id);
            $(".right-date-tube").html("Kitty" + " #" + sire.sire_kitty.id);
        } else {
            $(".right-name").html("G" + sire.sire_kitty.generation + "-" + sire.sire_kitty.name);
            $(".right-date-tube").html("G" + sire.sire_kitty.generation + "-" + sire.sire_kitty.name);
        }

        $(".left-kitty").css("background-color", sire.your_kitty.color);
        $(".left-kitty").css("background-image", "url(" + sire.your_kitty.image_url + ")");

        $(".right-kitty").css("background-color", sire.sire_kitty.color);
        $(".right-kitty").css("background-image", "url(" + sire.sire_kitty.image_url + ")");

        $(".left-kitty-gen").html(LText.Kitty + " #" + sire.your_kitty.id + "-" + LText.Generation + " " + sire.your_kitty.generation);
        $(".right-kitty-gen").html(LText.Kitty + " #" + sire.sire_kitty.id + "-" + LText.Generation + " " + sire.sire_kitty.generation);

        $(".left-kitty-cool").html(cooldown[sire.your_kitty.cooldown_index]);
        $(".right-kitty-cool").html(cooldown[sire.sire_kitty.cooldown_index]);

        $(".right-kitty-spend").html(LText.WantsToSire + " " + sirePrice.toFixed(4));
    } catch (e) {
        console.log(e);
    }
}

var yourKittyId;
var findKittyInfo = function (sireKittyId) {
    $.ajax({
        url: Config.address + "sire/getKittiesInfo",
        type: "POST",
        data: {
            "kittyId": sireKittyId,
            "uId": userId,
        },
        success: function (response) {
            console.log(response.msg);
            showInfo(response.msg.show_kitty);
            getMyKitty(response.msg.my_kitties);
            destory();
            yourKittyId = response.msg.show_kitty.your_kitty.id;
        },
        error: function (error) {
            var text = nextJson(LText.Title, LText.SystemTitle, 1, [LText.Ok], [OK]);
            promptText(text);
            destory();
        }
    });
}

var width = screen.width;
/**
 * 创建生成的小猫
 */
var createShowChildCanvas = function (data) {
    var msg = data.msg;
    var array;
    try {
        array = msg.attribute;
    } catch (e) {
        // hideWaitView();
        failModel("", null);
        destory();
        return;
    }
    $("body").append(
        "<div class='div-show-child'>" +
        "<div class='div-show-child-body'>" +
        "<canvas class=\"div-show-child-canvas\" " +
        "width=\"" + width + "px\" height=\"" + width + "px\">" +
        "</canvas>" +
        "<div class='div-show-child-content'>" +
        "<span>" + "Kitty #" + data.msg.id + "</span>" +
        "<br/>" +
        "<span>" + "FancyType : " + data.msg.fancy_type + "</span>" +
        "</div>" +
        "</div>" +
        "</div>"
    );

    var i1 = new Image();
    i1.src = "../kitty_svg/tail_" + array[0] + ".svg";
    var i2 = new Image();
    i2.src = "../kitty_svg/body_" + array[1] + ".svg";
    var i3 = new Image();
    i3.src = "../kitty_svg/eye_" + array[2] + ".svg";
    var i4 = new Image();
    i4.src = "../kitty_svg/mouth_" + array[3] + ".svg";
    document.body.appendChild(i1);
    document.body.appendChild(i2);
    document.body.appendChild(i3);
    document.body.appendChild(i4);
    i1.onload = function () {
        showChild(data, i1, i2, i3, i4);
    };
    i2.onload = function () {
        showChild(data, i1, i2, i3, i4);
    };
    i3.onload = function () {
        showChild(data, i1, i2, i3, i4);
    };
    i4.onload = function () {
        showChild(data, i1, i2, i3, i4);
    };

};


var index = 0; //已有几个部件加载完成
/**
 * 画出小猫
 * @param data
 * @param i1
 * @param i2
 * @param i3
 * @param i4
 */
var showChild = function (data, i1, i2, i3, i4) {
    index += 1;
    if (index == 4) {
        var can = $(".div-show-child-canvas")[0];
        var g = can.getContext('2d');
        // g.scale(2, 2);
        g.drawImage(i1, 0, 0, width, width);
        g.drawImage(i2, 0, 0, width, width);
        g.drawImage(i3, 0, 0, width, width);
        g.drawImage(i4, 0, 0, width, width);
        i1.style.display = "none";
        i2.style.display = "none";
        i3.style.display = "none";
        i4.style.display = "none";
        document.body.removeChild(i1);
        document.body.removeChild(i2);
        document.body.removeChild(i3);
        document.body.removeChild(i4);

        setTimeout(function () {
            var url = can.toDataURL('image/png', 1.0);
            $.ajax({
                url: Config.address + "uploadV2",
                data: data.msg.id + "," + url,
                type: "POST",
                processData: false,
                contentType: false,
                cache: false,
            }).done(function (res) {
                $(".div-show-child").on("click", hideChildView);
                console.log(res);
                // hideWaitView();
                destory();
                $(".div-show-child").on("click", hideChildView);
            }).fail(function (res) {
                console.log(res);
                // hideWaitView();
                failModel();
            });
        }, 1000);
    }
};

//隱藏展示的小kitty界面
var hideChildView = function () {
    index = 0;
    $(".div-show-child").remove();
    marketInit();
};

/**
 * 查询可以交配的kitty
 */
var getNotSireKitties = function () {
    $.ajax({
        url: Config.address + "sire/getNotSiredKitties",
        type: "POST",
        data: {
            "kittyId": 0,
            "uId": userId
        },
        success: function (response) {
            console.log(response.msg);
            getMyKitty(response.msg);
        },
        error: function (error) {
            console.info(error);
        }
    });
}

var kitties = new Array();
//查询我的能够交配的猫
var getMyKitty = function (my_kitties) {
    kitties = my_kitties;
    //我的猫数据 my_kitties
    for (var index in my_kitties) {
        var optionContent;
        try {
            optionContent = "undefined" == typeof (my_kitties[index].name) ? ("Kitty #" + my_kitties[index].id) : my_kitties[index].name;
        } catch (e) {
            console.log(e);
        }
        var my_kittiesText =
            '<option value="' + index + '">' + optionContent + '</option>';
        $(".select-input select").append(my_kittiesText);
    }
}

//选择我的要交配的猫
var chooseSireKitty = function () {
    var kittyValue = $(".select-input select").val();
    if (kittyValue != null && kittyValue != "") {
        updateSireKitty(kitties[kittyValue]);
    }

}

//更新我的要交配的猫
var updateSireKitty = function (sireData) {
    try {
        if ("undefined" == typeof (sireData.name) || sireData.name == "") {
            $(".left-name").html("Kitty" + " #" + sireData.id);
            $(".left-date-tube").html("Kitty" + " #" + sireData.id);
        } else {
            $(".left-name").html("G" + sireData.generation + "-" + sireData.name);
            $(".left-date-tube").html("G" + sireData.generation + "-" + sireData.name);
        }

        $(".left-kitty").css("background-color", sireData.color);
        $(".left-kitty").css("background-image", "url(" + sireData.image_url + ")");

        $(".left-kitty-gen").html("Kitty" + " #" + sireData.id + "-" + "Gen " + sireData.generation);
        $(".left-kitty-cool").html(cooldown[sireData.cooldown_index]);
    } catch (e) {
        console.log(e);
    }
}